---
layout: post
title: Leafcutter installation notes
---

# Leafcutter as a software test

This guide will explain how to install [leafcutter](https://davidaknowles.github.io/leafcutter/articles/Installation.html) on the *RockFish* cluster. It serves as a demonstration of the [Spack-based]() R library system which seeks to standardize and pre-build commonly used R packages. This test was inspired by a user support request from the *BlueCrab* cluster.

The following commands can be used to install the system. Note that the admin who tested this has cleared his `~/rlibs` and `~/local` and `~/.local` paths beforehand to simulate a clean installation.

~~~
# step 1: install v8
# the v8-devel package is a requirement which is not yet available on our system
# we will install it with a helper
# first, collect the RPM target URLs
cat > install.txt <<EOF
https://download-ib01.fedoraproject.org/pub/epel/7/x86_64/Packages/v/v8-devel-3.14.5.10-25.el7.x86_64.rpm
https://download-ib01.fedoraproject.org/pub/epel/7/x86_64/Packages/v/v8-3.14.5.10-25.el7.x86_64.rpm
EOF
# use the helpers to install this
ml helpers
local-rpms.py -t install.txt -n v8
ml own v8
# step 2: load the modules
ml gcc r/4.0.2 r-devtools
ml r-rcpp r-rstan r-rstantools r-foreach r-ggplot2 r-r-utils r-gridextra r-reshape2 r-hmisc r-dplyr r-domc r-optparse r-shiny r-intervals r-dt r-gtable r-magrittr r-stringr
ml r-dirichletmultinomial
ml libjpeg libpng
# step 3: update stantools
R
.libPaths(c("~/rlibs/4.0.2/gcc/9.3.0",.libPaths()))
install.packages('rstantools')
quit()
# step 4: preemptively install V8 because we see errors later
up=http://cran.r-project.org/src/contrib/V8_3.3.1.tar.gz
wget $up
# need to go back out after first install to rlibs
# before the install we have to export the library for some reason
export R_LIBS_USER=${R_LIBS_USER-'~/rlibs/4.0.2/gcc/9.3.0'}
R CMD INSTALL --library=$R_LIBS_USER --configure-vars='INCLUDE_DIR=~/local/v8/usr/include LIB_DIR=~/local/v8/usr/lib64' $(basename $up)
# step 5: install leafcutter
R
# critical that this path exists or you get an error
.libPaths(c("~/rlibs/4.0.2/gcc/9.3.0",.libPaths()))
library(devtools)
if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
BiocManager::install("Biobase")
devtools::install_github("davidaknowles/leafcutter/leafcutter")
library(leafcutter)
~~~

In conclusion, the procedure above demonstrates the method for using rootless package installs and pre-built R libraries generated by Spack and integrated into Lmod to support a piece of academic software with complex dependencies. The author has not tested or confirmed that the target package (that is, leafcutter) works as intended. The goal of this exercise is to simply complete the installation. Users must be sure to follow complete and robust documentation produced by the package authors in order to actually *use* the code in their work.